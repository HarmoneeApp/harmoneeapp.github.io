<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="theme-color" content="#ff512f">
		<title>Harmonee</title>
		<link rel="icon" href="img/logo.png">
		<link rel="preconnect" href="https://fonts.gstatic.com">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap">
		<link rel="stylesheet" href="css/style.css">
	</head>
	<body>
		<!-- Firebase SDKs -->
		<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-analytics.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-auth.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-database.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-storage.js"></script>
		<!-- Firebase Configuration -->
		<script>
			// Your web app's Firebase configuration
			var firebaseConfig = {
				apiKey: "AIzaSyBEZIIAwiXw-UwNZKmsk9ac-5EprpBRV28",
				authDomain: "harmonee-eb104.firebaseapp.com",
				databaseURL: "https://harmonee-eb104-default-rtdb.firebaseio.com",
				projectId: "harmonee-eb104",
				storageBucket: "harmonee-eb104.firebasestorage.app",
				messagingSenderId: "186610294157",
				appId: "1:186610294157:web:4fde0e31525a9dd9c671c4",
				measurementId: "G-5EFYQC8WR7"
			};
			// Initialize Firebase
			firebase.initializeApp(firebaseConfig);
			firebase.analytics();
		</script>
		<!-- Navigation -->
		<div class="tab">
			<button class="tab-link" onclick="showTab(event, 'feed')" id="default">Feed</button>
			<button class="tab-link" onclick="showTab(event, 'search')">Search</button>
			<button class="tab-link" onclick="showTab(event, 'messages')">Messages</button>
			<button class="profile-button" onclick="showProfileMenu()"><img id="avatar-icon" class="avatar-icon"></button>
		</div>
		<div class="profile-menu" id="profileMenu">
			<div class="menu-item" onclick="showProfile()">Profile</div>
			<div class="menu-item" onclick="signOutUser()">Sign Out</div>
		</div>
		<!-- Feed -->
		<div id="feed" class="tab-content">
			<!-- New Post -->
			<div class="newpost-view">
				<textarea id="postcontent" class="post-textarea" spellcheck="false" maxlength="420" placeholder="What's happening?" onkeyup="autogrow(this)"></textarea>
				<button class="newpost-button" onclick="createPost()">Post</button>
				<div id="count">
					<span id="current_count">0</span>
					<span id="maximum_count">/ 420</span>
				</div>
			</div>
		</div>
		<!-- Search -->
		<div id="search" class="tab-content">
			<center>
				<p class="tab-title">Coming Soon</p>
			</center>
		</div>
		<!-- Messages -->
		<div id="messages" class="tab-content">
			<center>
				<p class="tab-title">Coming Soon</p>
			</center>
		</div>
		<!-- Profile -->
		<div id="profile" class="tab-content">
			<div class="profile-container">
				<div class="profile-header">
					<img class="profile-image">
					<div class="profile-info">
						<br>
						<span class="profile-name">Name</span>
						<br>
						<span class="profile-username">Username</span>
						<div class="edit-button" onclick="editProfile()">Edit Profile</div>
					</div>
					
				</div>
				<div id="edit-profile" class="modal">
					<div class="modal-content">
						<div class="modal-header">
							<p class="header-text">Edit Profile</p>
						</div>
						<div class="modal-body">
							<center>
								<div class="update-avatar">
									<input type="file" accept="image/jpeg, image/png" id="edit-avatar" onchange="uploadAvatar(event)">
									<label for="edit-avatar" id="avatar-button">Upload</label>
								</div>
							</center>
							<label for="edit-displayname" class="modal-label">Display Name</label>
							<input type="text" class="modal-input" spellcheck="false" id="edit-displayname">
							<label for="edit-username" class="modal-label">Username</label>
							<input type="text" class="modal-input" spellcheck="false" id="edit-username">
							<label for="edit-website" class="modal-label">Website</label>
							<input type="text" class="modal-input" spellcheck="false" id="edit-website">
						</div>
						<div class="modal-footer">
							<div class="footer-button" onclick="closeModal()">Cancel</div>
							<div class="footer-button" onclick="updateProfileInfo()">Save Changes</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- Other Scripts -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<script src="https://unpkg.com/sweetalert2/dist/sweetalert2.all.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9.3.4/dist/sweetalert2.all.min.js"></script>
		<script src="js/app.js"></script>
		<script src="js/main.js"></script>
		<!-- Custom Scripts -->
		<script>
			var didSignIn = false;

			firebase.auth().onAuthStateChanged(function(user) {
				if (user) {
					// User is signed in.
					didSignIn = true;

					loadProfilePicture(user.uid);
					loadProfileInfo(user.uid);
				} else {
					if (didSignIn) {
						Swal.fire({
							title: "You were successfully signed out.",
							icon: "success",
							confirmButtonText: "Okay"
						}).then((value) => {
							setTimeout(function() {
								window.location.replace("welcome.html");
							}, 1000);
						});
					} else {
						window.location.replace("welcome.html");
					}
				}
			});

			function loadProfilePicture(userID) {
				firebase.storage().ref().child(userID).child("avatar.png").getDownloadURL().then((url) => {
					var avatarView = document.getElementById("avatar-icon");
					var profileImage = document.getElementsByClassName("profile-image")[0];

					var updateAvatarView = document.getElementsByClassName("update-avatar")[0];

					avatarView.setAttribute('src', url);
					profileImage.setAttribute('src', url);

					updateAvatarView.style.backgroundImage = 'url(' + url + ')';
				}).catch((error) => {
					var errorCode = error.code;
					var errorMessage = error.message;

					Swal.fire({
						title: "Error!",
						text: errorMessage,
						icon: "error",
						confirmButtonText: "Okay"
					});
				});
			}

			function loadProfileInfo(userID) {
				var profileNameLabel = document.getElementsByClassName("profile-name")[0];
				var profileUsernameLabel = document.getElementsByClassName("profile-username")[0];

				var editProfileNameLabel = document.getElementById("edit-displayname");
				var editProfileUsernameLabel = document.getElementById("edit-username");

				return firebase.database().ref("/users/" + userID).once("value").then((snapshot) => {
					var displayName = (snapshot.val() && snapshot.val().displayName) || "Display Name";
					var username = (snapshot.val() && snapshot.val().username) || "Username";
					var verified = (snapshot.val() && snapshot.val().verified) || false;

					profileNameLabel.textContent = displayName;
					profileUsernameLabel.textContent = "@" + username;
				
					editProfileNameLabel.value = displayName;
					editProfileUsernameLabel.value = username;
				});
			}

			// Post Character Count
			$("#postcontent").keyup(function() {
				var characterCount = $(this).val().length,
				current_count = $("#current_count"),
				maximum_count = $("maximum_count"),
				count = $("#count");

				current_count.text(characterCount);
			});
		</script>
	</body>
</html>